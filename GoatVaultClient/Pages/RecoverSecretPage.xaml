<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="GoatVaultClient.Pages.RecoverSecretPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:converters="clr-namespace:GoatVaultClient.Converters"
    xmlns:material="http://schemas.enisn-projects.io/dotnet/maui/uraniumui/material"
    xmlns:models="clr-namespace:GoatVaultCore.Models.Shamir;assembly=GoatVaultCore"
    xmlns:vm="clr-namespace:GoatVaultClient.ViewModels"
    Title="Recover Secret"
    x:DataType="vm:RecoverSecretViewModel">

    <ContentPage.Resources>
        <converters:InvertedBoolConverter x:Key="BoolInverter" />
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Padding="{StaticResource pMedium}" Spacing="{StaticResource formSpacing}">

            <Label
                Margin="0,8,0,0"
                Style="{StaticResource MaterialHeadlineSmall}"
                Text="Recover a Secret" />
            <Label
                Opacity="0.7"
                Style="{StaticResource MaterialBodyMedium}"
                Text="Collect enough SLIP-39 mnemonic shares to reconstruct the original secret." />

            <Border
                Padding="{StaticResource pMedium}"
                BackgroundColor="{AppThemeBinding Light={StaticResource LightSurfaceContainerLow},
                                                  Dark={StaticResource DarkSurfaceContainerLow}}"
                IsEnabled="{Binding HasRecoveredSecret, Converter={StaticResource BoolInverter}}"
                Stroke="{AppThemeBinding Light={StaticResource LightOutline},
                                         Dark={StaticResource DarkOutline}}"
                StrokeShape="RoundRectangle 8">
                <VerticalStackLayout Spacing="{StaticResource sContent}">
                    <Label
                        Style="{StaticResource MaterialLabelMedium}"
                        Text="Passphrase (Optional)"
                        TextColor="{AppThemeBinding Light={StaticResource LightPrimary},
                                                    Dark={StaticResource DarkPrimary}}" />
                    <Label
                        Opacity="0.6"
                        Style="{StaticResource MaterialBodySmall}"
                        Text="Enter the passphrase if one was used during the splitting process." />
                    <material:TextField
                        Title="Passphrase"
                        AllowClear="True"
                        IsPassword="True"
                        Text="{Binding Passphrase}" />
                </VerticalStackLayout>
            </Border>

            <Border
                Padding="{StaticResource pMedium}"
                BackgroundColor="{AppThemeBinding Light={StaticResource LightSurfaceContainerLow},
                                                  Dark={StaticResource DarkSurfaceContainerLow}}"
                IsEnabled="{Binding HasRecoveredSecret, Converter={StaticResource BoolInverter}}"
                Stroke="{AppThemeBinding Light={StaticResource LightOutline},
                                         Dark={StaticResource DarkOutline}}"
                StrokeShape="RoundRectangle 8">
                <VerticalStackLayout Spacing="10">
                    <Grid ColumnDefinitions="*,Auto">
                        <Label
                            Style="{StaticResource MaterialLabelMedium}"
                            Text="Mnemonic Shares"
                            TextColor="{AppThemeBinding Light={StaticResource LightPrimary},
                                                        Dark={StaticResource DarkPrimary}}" />
                        <Border
                            Grid.Column="1"
                            Padding="10,3"
                            BackgroundColor="{AppThemeBinding Light={StaticResource LightTertiaryContainer},
                                                              Dark={StaticResource DarkTertiaryContainer}}"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 6">
                            <Label Style="{StaticResource MaterialLabelSmall}" TextColor="{AppThemeBinding Light={StaticResource LightOnTertiaryContainer}, Dark={StaticResource DarkOnTertiaryContainer}}">
                                <Label.FormattedText>
                                    <FormattedString>
                                        <Span Text="{Binding ShareCount}" />
                                        <Span Text=" added" />
                                    </FormattedString>
                                </Label.FormattedText>
                            </Label>
                        </Border>
                    </Grid>

                    <Label
                        Opacity="0.6"
                        Style="{StaticResource MaterialBodySmall}"
                        Text="Enter each shareholder's mnemonic words one at a time." />
                    <material:TextField
                        Title="Paste mnemonic words here"
                        AllowClear="True"
                        Text="{Binding CurrentShareInput}" />

                    <FlexLayout
                        AlignItems="Center"
                        Direction="Row"
                        JustifyContent="Start"
                        Wrap="Wrap">
                        <Button
                            Margin="0,0,8,0"
                            Padding="12,6"
                            BackgroundColor="{AppThemeBinding Light={StaticResource LightSurfaceVariant},
                                                              Dark={StaticResource DarkSurfaceVariant}}"
                            Command="{Binding PasteShareCommand}"
                            CornerRadius="8"
                            FontSize="12"
                            HeightRequest="36"
                            Text="Paste"
                            TextColor="{AppThemeBinding Light={StaticResource LightOnSurfaceVariant},
                                                        Dark={StaticResource DarkOnSurfaceVariant}}" />
                        <Button
                            Padding="14,6"
                            BackgroundColor="{AppThemeBinding Light={StaticResource LightPrimaryContainer},
                                                              Dark={StaticResource DarkPrimaryContainer}}"
                            Command="{Binding AddShareCommand}"
                            CornerRadius="8"
                            FontSize="12"
                            HeightRequest="36"
                            Text="Add Share"
                            TextColor="{AppThemeBinding Light={StaticResource LightOnPrimaryContainer},
                                                        Dark={StaticResource DarkOnPrimaryContainer}}" />
                    </FlexLayout>

                    <CollectionView IsVisible="{Binding HasShares}" ItemsSource="{Binding CollectedShares}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:RecoveryShare">
                                <Border
                                    Margin="0,4"
                                    Padding="12,8"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource LightSurfaceContainerHighest},
                                                                      Dark={StaticResource DarkSurfaceContainerHighest}}"
                                    Stroke="Transparent"
                                    StrokeShape="RoundRectangle 8">
                                    <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto">
                                        <Label
                                            Style="{StaticResource MaterialLabelMedium}"
                                            Text="{Binding DisplayLabel}"
                                            VerticalOptions="Center" />
                                        <Button
                                            Grid.RowSpan="2"
                                            Grid.Column="1"
                                            Padding="0"
                                            BackgroundColor="{AppThemeBinding Light={StaticResource LightErrorContainer},
                                                                              Dark={StaticResource DarkErrorContainer}}"
                                            Command="{Binding Path=RemoveShareCommand}"
                                            CommandParameter="{Binding .}"
                                            CornerRadius="8"
                                            FontSize="14"
                                            HeightRequest="36"
                                            Text="âœ•"
                                            TextColor="{AppThemeBinding Light={StaticResource LightOnErrorContainer},
                                                                        Dark={StaticResource DarkOnErrorContainer}}"
                                            VerticalOptions="Center"
                                            WidthRequest="36" x:DataType="vm:RecoverSecretViewModel" />
                                        <Label
                                            Grid.Row="1"
                                            LineBreakMode="TailTruncation"
                                            MaxLines="1"
                                            Opacity="0.6"
                                            Style="{StaticResource MaterialBodySmall}"
                                            Text="{Binding Mnemonic}" />
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </Border>

            <Button
                Command="{Binding RecoverCommand}"
                CornerRadius="12"
                HeightRequest="{StaticResource buttonHeight}"
                IsVisible="{Binding HasRecoveredSecret, Converter={StaticResource BoolInverter}}"
                Text="Recover Secret" />
            <ActivityIndicator
                HorizontalOptions="Center"
                IsRunning="{Binding IsBusy}"
                IsVisible="{Binding IsBusy}" />

            <Border
                Padding="{StaticResource pMedium}"
                BackgroundColor="{AppThemeBinding Light={StaticResource LightErrorContainer},
                                                  Dark={StaticResource DarkErrorContainer}}"
                IsVisible="{Binding HasError}"
                Stroke="Transparent"
                StrokeShape="RoundRectangle 8">
                <VerticalStackLayout Spacing="4">
                    <Label
                        Style="{StaticResource MaterialTitleSmall}"
                        Text="Recovery Failed"
                        TextColor="{AppThemeBinding Light={StaticResource LightOnErrorContainer},
                                                    Dark={StaticResource DarkOnErrorContainer}}" />
                    <Label
                        Style="{StaticResource MaterialBodySmall}"
                        Text="{Binding ErrorMessage}"
                        TextColor="{AppThemeBinding Light={StaticResource LightOnErrorContainer},
                                                    Dark={StaticResource DarkOnErrorContainer}}" />
                </VerticalStackLayout>
            </Border>

            <Border
                Padding="{StaticResource pMedium}"
                BackgroundColor="{AppThemeBinding Light={StaticResource LightPrimaryContainer},
                                                  Dark={StaticResource DarkPrimaryContainer}}"
                IsVisible="{Binding HasRecoveredSecret}"
                Stroke="{AppThemeBinding Light={StaticResource LightPrimary},
                                         Dark={StaticResource DarkPrimary}}"
                StrokeShape="RoundRectangle 12"
                StrokeThickness="2">
                <VerticalStackLayout Spacing="10">
                    <Label
                        Style="{StaticResource MaterialTitleSmall}"
                        Text="Recovered Secret"
                        TextColor="{AppThemeBinding Light={StaticResource LightOnPrimaryContainer},
                                                    Dark={StaticResource DarkOnPrimaryContainer}}" />
                    <Border
                        Padding="12,10"
                        BackgroundColor="{AppThemeBinding Light={StaticResource LightSurfaceContainerHighest},
                                                          Dark={StaticResource DarkSurfaceContainerHighest}}"
                        Stroke="Transparent"
                        StrokeShape="RoundRectangle 6">
                        <Label
                            FontFamily="{StaticResource MaterialRegularFont}"
                            IsVisible="{Binding IsSecretVisible}"
                            LineBreakMode="WordWrap"
                            Style="{StaticResource MaterialBodyMedium}"
                            Text="{Binding RecoveredSecret}" />
                    </Border>
                    <Label
                        IsVisible="{Binding IsSecretVisible, Converter={StaticResource BoolInverter}}"
                        Opacity="0.6"
                        Style="{StaticResource MaterialBodySmall}"
                        Text="Tap 'Show' to reveal the recovered secret." />
                    <FlexLayout
                        AlignItems="Center"
                        Direction="Row"
                        JustifyContent="End"
                        Wrap="Wrap">
                        <Button
                            Margin="0,0,6,0"
                            Padding="14,6"
                            BackgroundColor="{AppThemeBinding Light={StaticResource LightSecondaryContainer},
                                                              Dark={StaticResource DarkSecondaryContainer}}"
                            Command="{Binding ToggleSecretVisibilityCommand}"
                            CornerRadius="8"
                            FontSize="12"
                            HeightRequest="36"
                            Text="{Binding IsSecretVisible, StringFormat='{0:Show;Show;Hide}'}"
                            TextColor="{AppThemeBinding Light={StaticResource LightOnSecondaryContainer},
                                                        Dark={StaticResource DarkOnSecondaryContainer}}" />
                        <Button
                            Margin="0,0,6,0"
                            Padding="14,6"
                            BackgroundColor="{AppThemeBinding Light={StaticResource LightPrimary},
                                                              Dark={StaticResource DarkPrimary}}"
                            Command="{Binding CopyRecoveredSecretCommand}"
                            CornerRadius="8"
                            FontSize="12"
                            HeightRequest="36"
                            Text="Copy Secret"
                            TextColor="{AppThemeBinding Light={StaticResource LightOnPrimary},
                                                        Dark={StaticResource DarkOnPrimary}}" />
                        <Button
                            Padding="14,6"
                            BackgroundColor="{AppThemeBinding Light={StaticResource LightSurfaceVariant},
                                                              Dark={StaticResource DarkSurfaceVariant}}"
                            Command="{Binding ResetCommand}"
                            CornerRadius="8"
                            FontSize="12"
                            HeightRequest="36"
                            Text="Reset"
                            TextColor="{AppThemeBinding Light={StaticResource LightOnSurfaceVariant},
                                                        Dark={StaticResource DarkOnSurfaceVariant}}" />
                    </FlexLayout>
                </VerticalStackLayout>
            </Border>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="GoatVaultClient.Pages.SplitSecretPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:converters="clr-namespace:GoatVaultClient.Converters"
    xmlns:material="http://schemas.enisn-projects.io/dotnet/maui/uraniumui/material"
    xmlns:models="clr-namespace:GoatVaultCore.Models.Shamir;assembly=GoatVaultCore"
    xmlns:vm="clr-namespace:GoatVaultClient.ViewModels"
    xmlns:abstractions="clr-namespace:GoatVaultCore.Abstractions;assembly=GoatVaultCore"
    Title="Split Secret">

    <ContentPage.Resources>
        <converters:InvertedBoolConverter x:Key="BoolInverter" />
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Padding="{StaticResource pMedium}" Spacing="{StaticResource formSpacing}">

            <Label
                Margin="0,8,0,0"
                Style="{StaticResource MaterialHeadlineSmall}"
                Text="Split a Secret" />
            <Label
                Opacity="0.7"
                Style="{StaticResource MaterialBodyMedium}"
                Text="Encrypt your secret and split it into SLIP-39 mnemonic shares." />

            <Border
                Padding="{StaticResource pMedium}"
                BackgroundColor="{AppThemeBinding Light={StaticResource LightSurfaceContainerLow},
                                                  Dark={StaticResource DarkSurfaceContainerLow}}"
                Stroke="{AppThemeBinding Light={StaticResource LightOutline},
                                         Dark={StaticResource DarkOutline}}"
                StrokeShape="RoundRectangle 8">
                <VerticalStackLayout Spacing="{StaticResource sContent}">
                    <Label
                        Style="{StaticResource MaterialLabelMedium}"
                        Text="Your Secret"
                        TextColor="{AppThemeBinding Light={StaticResource LightPrimary},
                                                    Dark={StaticResource DarkPrimary}}" />
                    <material:TextField
                        Title="Your Master Password"
                        AllowClear="True"
                        IsEnabled="false"
                        IsPassword="True"
                        Text="{Binding Mp}" x:DataType="vm:SplitSecretViewModel" />

                    <Label
                        Margin="0,12,0,0"
                        Style="{StaticResource MaterialLabelMedium}"
                        Text="Passphrase"
                        TextColor="{AppThemeBinding Light={StaticResource LightPrimary},
                                                    Dark={StaticResource DarkPrimary}}" />
                    <material:TextField
                        Title="Adds an extra layer of protection"
                        AllowClear="True"
                        IsEnabled="{Binding HasResults, Converter={StaticResource BoolInverter}}"
                        IsPassword="True"
                        Text="{Binding Passphrase}" x:DataType="vm:SplitSecretViewModel" />
                </VerticalStackLayout>
            </Border>

            <Border
                Padding="{StaticResource pMedium}"
                BackgroundColor="{AppThemeBinding Light={StaticResource LightSurfaceContainerLow},
                                                  Dark={StaticResource DarkSurfaceContainerLow}}"
                IsEnabled="{Binding HasResults, Converter={StaticResource BoolInverter}}"
                Stroke="{AppThemeBinding Light={StaticResource LightOutline},
                                         Dark={StaticResource DarkOutline}}"
                StrokeShape="RoundRectangle 8">
                <VerticalStackLayout Spacing="12">
                    <Label
                        Style="{StaticResource MaterialLabelMedium}"
                        Text="Configuration"
                        TextColor="{AppThemeBinding Light={StaticResource LightPrimary},
                                                    Dark={StaticResource DarkPrimary}}" />

                    <VerticalStackLayout Spacing="4">
                        <Grid ColumnDefinitions="*,Auto">
                            <Label
                                Style="{StaticResource MaterialBodyMedium}"
                                Text="Total Shares"
                                VerticalOptions="Center" />
                            <Border
                                Grid.Column="1"
                                Padding="12,4"
                                BackgroundColor="{AppThemeBinding Light={StaticResource LightPrimaryContainer},
                                                                  Dark={StaticResource DarkPrimaryContainer}}"
                                HorizontalOptions="End"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 6">
                                <Label
                                    HorizontalOptions="Center"
                                    Style="{StaticResource MaterialTitleMedium}"
                                    Text="{Binding TotalShares}"
                                    TextColor="{AppThemeBinding Light={StaticResource LightOnPrimaryContainer},
                                                                Dark={StaticResource DarkOnPrimaryContainer}}"
                                    x:DataType="vm:SplitSecretViewModel" />
                            </Border>
                        </Grid>
                        <Slider
                            Maximum="{Binding MaxShares}"
                            Minimum="{Binding MinShares}"
                            Value="{Binding TotalShares}"/>
                    </VerticalStackLayout>

                    <VerticalStackLayout Spacing="4">
                        <Grid ColumnDefinitions="*,Auto">
                            <Label
                                Style="{StaticResource MaterialBodyMedium}"
                                Text="Threshold (min. to recover)"
                                VerticalOptions="Center" />
                            <Border
                                Grid.Column="1"
                                Padding="12,4"
                                BackgroundColor="{AppThemeBinding Light={StaticResource LightTertiaryContainer},
                                                                  Dark={StaticResource DarkTertiaryContainer}}"
                                HorizontalOptions="End"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 6">
                                <Label
                                    HorizontalOptions="Center"
                                    Style="{StaticResource MaterialTitleMedium}"
                                    Text="{Binding Threshold}"
                                    TextColor="{AppThemeBinding Light={StaticResource LightOnTertiaryContainer},
                                                                Dark={StaticResource DarkOnTertiaryContainer}}"
                                    x:DataType="vm:SplitSecretViewModel" />
                            </Border>
                        </Grid>
                        <Slider
                            Maximum="{Binding MaxThreshold}"
                            Minimum="{Binding MinThreshold}"
                            Value="{Binding Threshold}"/>
                    </VerticalStackLayout>

                    <Border
                        Padding="12,8"
                        BackgroundColor="{AppThemeBinding Light={StaticResource LightSurfaceVariant},
                                                          Dark={StaticResource DarkSurfaceVariant}}"
                        Stroke="Transparent"
                        StrokeShape="RoundRectangle 6">
                        <Label Style="{StaticResource MaterialBodySmall}" TextColor="{AppThemeBinding Light={StaticResource LightOnSurfaceVariant}, Dark={StaticResource DarkOnSurfaceVariant}}">
                            <Label.FormattedText>
                                <FormattedString>
                                    <Span Text="Any " />
                                    <Span FontAttributes="Bold" Text="{Binding Threshold}" x:DataType="vm:SplitSecretViewModel" />
                                    <Span Text=" of " />
                                    <Span FontAttributes="Bold" Text="{Binding TotalShares}" x:DataType="vm:SplitSecretViewModel" />
                                    <Span Text=" shareholders can recover the secret." />
                                </FormattedString>
                            </Label.FormattedText>
                        </Label>
                    </Border>
                </VerticalStackLayout>
            </Border>

            <Button
                Command="{Binding SplitCommand}"
                CornerRadius="12"
                HeightRequest="{StaticResource buttonHeight}"
                IsVisible="{Binding HasResults, Converter={StaticResource BoolInverter}}"
                Text="Split Secret" x:DataType="vm:SplitSecretViewModel" />

            <ActivityIndicator
                HorizontalOptions="Center"
                IsRunning="{Binding IsBusy}"
                IsVisible="{Binding IsBusy}" x:DataType="vm:RecoverSecretViewModel" />

            <Border
                Padding="{StaticResource pMedium}"
                BackgroundColor="{AppThemeBinding Light={StaticResource LightErrorContainer},
                                                  Dark={StaticResource DarkErrorContainer}}"
                IsVisible="{Binding HasError}"
                Stroke="Transparent"
                StrokeShape="RoundRectangle 8" x:DataType="vm:RecoverSecretViewModel">
                <Label
                    Style="{StaticResource MaterialBodyMedium}"
                    Text="{Binding ErrorMessage}"
                    TextColor="{AppThemeBinding Light={StaticResource LightOnErrorContainer},
                                                Dark={StaticResource DarkOnErrorContainer}}"
                    x:DataType="abstractions:SyncFailedEventArgs" />
            </Border>

            <VerticalStackLayout IsVisible="{Binding HasResults}" Spacing="12" x:DataType="vm:SplitSecretViewModel">
                <Grid Margin="0,8,0,0" ColumnDefinitions="*,Auto">
                    <Label Style="{StaticResource MaterialTitleMedium}" Text="Generated Shares" />
                    <Button
                        Grid.Column="1"
                        Padding="16,6"
                        BackgroundColor="{AppThemeBinding Light={StaticResource LightSurfaceVariant},
                                                          Dark={StaticResource DarkSurfaceVariant}}"
                        Command="{Binding ResetCommand}"
                        CornerRadius="8"
                        HeightRequest="36"
                        Text="Reset"
                        TextColor="{AppThemeBinding Light={StaticResource LightOnSurfaceVariant},
                                                    Dark={StaticResource DarkOnSurfaceVariant}}"
                        x:DataType="vm:RecoverSecretViewModel" />
                </Grid>

                <CollectionView ItemsSource="{Binding GeneratedShares}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:RecoveryShare">
                            <Border
                                Margin="0,0,0,8"
                                Padding="{StaticResource pMedium}"
                                BackgroundColor="{AppThemeBinding Light={StaticResource LightSurfaceContainerLow},
                                                                  Dark={StaticResource DarkSurfaceContainerLow}}"
                                Stroke="{AppThemeBinding Light={StaticResource LightOutlineVariant},
                                                         Dark={StaticResource DarkOutlineVariant}}"
                                StrokeShape="RoundRectangle 12">
                                <VerticalStackLayout Spacing="8">
                                    <Label Style="{StaticResource MaterialTitleSmall}" Text="{Binding DisplayLabel}" />
                                    <Label
                                        Style="{StaticResource MaterialLabelSmall}"
                                        Text="Mnemonic (secret â€” write down carefully):"
                                        TextColor="{AppThemeBinding Light={StaticResource LightPrimary},
                                                                    Dark={StaticResource DarkPrimary}}" />
                                    <Border
                                        Padding="12,10"
                                        BackgroundColor="{AppThemeBinding Light={StaticResource LightSurfaceContainerHighest},
                                                                          Dark={StaticResource DarkSurfaceContainerHighest}}"
                                        Stroke="Transparent"
                                        StrokeShape="RoundRectangle 6">
                                        <Label
                                            FontFamily="{StaticResource MaterialRegularFont}"
                                            LineBreakMode="WordWrap"
                                            Style="{StaticResource MaterialBodySmall}"
                                            Text="{Binding Mnemonic}" />
                                    </Border>
                                    <FlexLayout
                                        AlignItems="Center"
                                        Direction="Row"
                                        JustifyContent="End"
                                        Wrap="Wrap">
                                        <Button
                                            Padding="14,6"
                                            BackgroundColor="{AppThemeBinding Light={StaticResource LightPrimaryContainer},
                                                                              Dark={StaticResource DarkPrimaryContainer}}"
                                            Command="{Binding Path=CopyShareCommand}"
                                            CommandParameter="{Binding .}"
                                            CornerRadius="8"
                                            FontSize="12"
                                            HeightRequest="36"
                                            Text="Copy Words"
                                            TextColor="{AppThemeBinding Light={StaticResource LightOnPrimaryContainer},
                                                                        Dark={StaticResource DarkOnPrimaryContainer}}"
                                            x:DataType="vm:SplitSecretViewModel" />
                                    </FlexLayout>
                                </VerticalStackLayout>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </VerticalStackLayout>
            <Button
                Command="{Binding ContinueCommand}"
                CornerRadius="12"
                HeightRequest="{StaticResource buttonHeight}"
                IsVisible="{Binding HasResults}"
                Text="Continue" x:DataType="vm:SplitSecretViewModel" />
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
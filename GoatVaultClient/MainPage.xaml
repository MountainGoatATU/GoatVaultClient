<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:uranium="http://schemas.enisn-projects.io/dotnet/maui/uraniumui"
             xmlns:material="http://schemas.enisn-projects.io/dotnet/maui/uraniumui/material"
             xmlns:vm="clr-namespace:GoatVaultClient.ViewModels"
             xmlns:models="clr-namespace:GoatVaultCore.Models;assembly=GoatVaultCore"
             xmlns:controls="clr-namespace:GoatVaultClient.Controls"
             xmlns:converters="clr-namespace:GoatVaultClient.Converters"
             xmlns:m="clr-namespace:UraniumUI.Icons.MaterialSymbols;assembly=UraniumUI.Icons.MaterialSymbols"
             xmlns:skia="clr-namespace:SkiaSharp.Extended.UI.Controls;assembly=SkiaSharp.Extended.UI"
             x:Class="GoatVaultClient.MainPage"
             BackgroundColor="{AppThemeBinding Light={x:StaticResource LightSurface}, Dark={x:StaticResource DarkSurface}}">

    <Grid>
        <VerticalStackLayout>
            <controls:SyncStatusBar x:Name="SyncStatusBar"/>

            <controls:Component BorderMargin="24,0,24,0">
                <SearchBar Placeholder="Search passwords..." Text="{Binding SearchText}" HeightRequest="48" />
            </controls:Component>
            <Grid RowDefinitions="Auto,Auto,*" ColumnDefinitions="Auto, 0.5*, 0.5*" Margin="{StaticResource layoutMargin}" BackgroundColor="{AppThemeBinding Light={x:StaticResource LightSurface}, Dark={x:StaticResource DarkSurface}}">

                <!-- Categories List-->
                <controls:Component Grid.Row="1" Grid.Column="0" >
                    <VerticalStackLayout>
                        <controls:ComponentHeader Title="Categories">
                            <controls:ComponentHeader.Actions>
                                <HorizontalStackLayout Spacing="{x:StaticResource sContent}">
                                    <controls:ImageButton IconGlyph="{x:Static m:MaterialRounded.Sort}"
                                                  Command="{Binding SortCategoriesCommand}"/>
                                    <controls:ImageButton IconGlyph="{x:Static m:MaterialRounded.Add}"
                                                  Command="{Binding CreateCategoryCommand}"/>
                                </HorizontalStackLayout>
                            </controls:ComponentHeader.Actions>
                        </controls:ComponentHeader >
                        <CollectionView x:Name="CategoriesCollection" ItemsSource="{Binding Categories}" SelectionMode="Single" SelectedItem="{Binding SelectedCategory}">
                            <CollectionView.ItemsLayout>
                                <LinearItemsLayout Orientation="Vertical" ItemSpacing="{x:StaticResource sContent}" />
                            </CollectionView.ItemsLayout>
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <controls:CategoryItemCell Text="{Binding Name}"
                                                       IconGlyph="{x:Static m:MaterialRounded.Folder}"         
                                                       ActionIconGlyph="{x:Static m:MaterialRounded.More_vert}">
                                        <!-- Context Menu-->
                                        <FlyoutBase.ContextFlyout>
                                            <MenuFlyout>
                                                <MenuFlyoutItem Text="Edit"
                                                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainPageViewModel}}, Path=EditCategoryCommand}"
                                                                CommandParameter="{Binding .}">
                                                    <MenuFlyoutItem.IconImageSource>
                                                        <FontImageSource FontFamily="MaterialRounded" Glyph="{x:Static m:MaterialRounded.Edit}" Color="{StaticResource Primary}"/>
                                                    </MenuFlyoutItem.IconImageSource>
                                                </MenuFlyoutItem>

                                                <MenuFlyoutItem Text="Delete"
                                                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainPageViewModel}}, Path=DeleteCategoryCommand}"
                                                                CommandParameter="{Binding .}">
                                                    <MenuFlyoutItem.IconImageSource>
                                                        <FontImageSource FontFamily="MaterialRounded" Glyph="{x:Static m:MaterialRounded.Delete}" Color="{StaticResource Error}"/>
                                                    </MenuFlyoutItem.IconImageSource>
                                                </MenuFlyoutItem>
                                            </MenuFlyout>
                                        </FlyoutBase.ContextFlyout>
                                    </controls:CategoryItemCell>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </controls:Component>
                <!-- Passsword Entries List -->
                <controls:Component Grid.Row="1" Grid.Column="1">
                    <VerticalStackLayout>
                        <controls:ComponentHeader Title="Passwords">
                            <controls:ComponentHeader.Actions>
                                <HorizontalStackLayout Spacing="{x:StaticResource sContent}"
                                               VerticalOptions="Center">
                                    <controls:ImageButton IconGlyph="{x:Static m:MaterialRounded.Sort}"
                                                  Command="{Binding SortEntriesCommand}"/>
                                    <controls:ImageButton IconGlyph="{x:Static m:MaterialRounded.Add}"
                                                  Command="{Binding CreateEntryCommand}"/>
                                </HorizontalStackLayout>
                            </controls:ComponentHeader.Actions>
                        </controls:ComponentHeader>
                        <CollectionView x:Name="EntriesCollection" ItemsSource="{Binding Passwords}" SelectionMode="Single" SelectedItem="{Binding SelectedEntry}">
                            <CollectionView.ItemsLayout>
                                <LinearItemsLayout Orientation="Vertical" ItemSpacing="{x:StaticResource sContent}" />
                            </CollectionView.ItemsLayout>
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <controls:CategoryItemCell Text="{Binding Site}"
                                       IconGlyph="{x:Static m:MaterialRounded.Key}"         
                                       ActionIconGlyph="{x:Static m:MaterialRounded.More_vert}">
                                        <!-- Context Menu-->
                                        <FlyoutBase.ContextFlyout>
                                            <MenuFlyout>
                                                <MenuFlyoutItem Text="Edit"
                                                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainPageViewModel}}, Path=EditEntryCommand}"
                                                                CommandParameter="{Binding .}">
                                                    <MenuFlyoutItem.IconImageSource>
                                                        <FontImageSource FontFamily="MaterialRounded" Glyph="{x:Static m:MaterialRounded.Edit}" Color="{StaticResource Primary}"/>
                                                    </MenuFlyoutItem.IconImageSource>
                                                </MenuFlyoutItem>
                                                <MenuFlyoutItem Text="Delete"
                                                                      Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainPageViewModel}}, Path=DeleteEntryCommand}"
                                                                      CommandParameter="{Binding .}">
                                                    <MenuFlyoutItem.IconImageSource>
                                                        <FontImageSource FontFamily="MaterialRounded" Glyph="{x:Static m:MaterialRounded.Delete}" Color="{StaticResource Error}"/>
                                                    </MenuFlyoutItem.IconImageSource>
                                                </MenuFlyoutItem>
                                            </MenuFlyout>
                                        </FlyoutBase.ContextFlyout>
                                    </controls:CategoryItemCell>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </controls:Component>
                <!-- Password Entry Details View -->
                <controls:Component Grid.Row="1" 
                                    Grid.Column="2" 
                                    BorderMargin="0"
                                    IsVisible="{Binding SelectedEntry, Converter={StaticResource IsNotNullConverter}}">
                    <controls:EntryDetailView Grid.Column="2" 
                          BindingContext="{Binding SelectedEntry}">
                        <controls:EntryDetailView.Triggers>
                            <DataTrigger TargetType="controls:EntryDetailView" 
                                 Binding="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SelectedEntry}"
                                 Value="{x:Null}">
                                <Setter Property="IsVisible" Value="False" />
                            </DataTrigger>
                        </controls:EntryDetailView.Triggers>
                    </controls:EntryDetailView>
                </controls:Component>
            </Grid>
        </VerticalStackLayout>
        <AbsoluteLayout InputTransparent="True" Margin="20" x:Name="GoatContainer">
            <!-- Goat Lottie animation -->
            <skia:SKLottieView
                x:Name="GoatMascot"
                Source="goat.json"
                RepeatCount="-1"
                HorizontalOptions="End"
                VerticalOptions="End"
                HeightRequest="120"
                WidthRequest="120"
                AbsoluteLayout.LayoutBounds="1,1,120,120"
                AbsoluteLayout.LayoutFlags="PositionProportional"/>
            <!-- Speech bubble above the goat -->
            <StackLayout x:Name="GoatBubbleStack" Spacing="0" Opacity="0" Orientation="Vertical" AbsoluteLayout.LayoutBounds="1,0.8,AutoSize,AutoSize" AbsoluteLayout.LayoutFlags="PositionProportional">
                <Border BackgroundColor="White" StrokeShape="RoundRectangle 12" Padding="12" HorizontalOptions="End">
                    <Label Text="{Binding GoatComment}" TextColor="Black" FontAttributes="Bold" LineBreakMode="WordWrap" MaxLines="3"/>
                </Border>
                <!-- Small triangle pointing to the goat -->
                <BoxView WidthRequest="12" HeightRequest="12" BackgroundColor="White" Rotation="45" HorizontalOptions="End" Margin="0,-8,16,0"/>
            </StackLayout>
        </AbsoluteLayout>
    </Grid>
</ContentPage>
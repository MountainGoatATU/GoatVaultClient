<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="GoatVaultClient.MainPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:controls="clr-namespace:GoatVaultClient.Controls"
    xmlns:converters="clr-namespace:GoatVaultClient.Converters"
    xmlns:m="clr-namespace:UraniumUI.Icons.MaterialSymbols;assembly=UraniumUI.Icons.MaterialSymbols"
    xmlns:material="http://schemas.enisn-projects.io/dotnet/maui/uraniumui/material"
    xmlns:models="clr-namespace:GoatVaultCore.Models;assembly=GoatVaultCore"
    xmlns:skia="clr-namespace:SkiaSharp.Extended.UI.Controls;assembly=SkiaSharp.Extended.UI"
    xmlns:uranium="http://schemas.enisn-projects.io/dotnet/maui/uraniumui"
    xmlns:vm="clr-namespace:GoatVaultClient.ViewModels"
    BackgroundColor="{AppThemeBinding Light={x:StaticResource LightSurface},
                                      Dark={x:StaticResource DarkSurface}}">

    <Grid>
        <VerticalStackLayout>
            <controls:SyncStatusBar x:Name="SyncStatusBar" />

            <controls:Component BorderMargin="24,0,24,0">
                <SearchBar
                    HeightRequest="48"
                    Placeholder="Search passwords..."
                    Text="{Binding SearchText}" />
            </controls:Component>
            <Grid
                Margin="{StaticResource layoutMargin}"
                BackgroundColor="{AppThemeBinding Light={x:StaticResource LightSurface},
                                                  Dark={x:StaticResource DarkSurface}}"
                ColumnDefinitions="Auto, 0.5*, 0.5*"
                RowDefinitions="Auto,Auto,*">

                <!--  Categories List  -->
                <controls:Component Grid.Row="1" Grid.Column="0">
                    <VerticalStackLayout>
                        <controls:ComponentHeader Title="Categories">
                            <controls:ComponentHeader.Actions>
                                <HorizontalStackLayout Spacing="{x:StaticResource sContent}">
                                    <controls:ImageButton Command="{Binding SortCategoriesCommand}" IconGlyph="{x:Static m:MaterialRounded.Sort}" />
                                    <controls:ImageButton Command="{Binding CreateCategoryCommand}" IconGlyph="{x:Static m:MaterialRounded.Add}" />
                                </HorizontalStackLayout>
                            </controls:ComponentHeader.Actions>
                        </controls:ComponentHeader>

                        <!--  Button to show all passwords, bypassing category filter  -->
                        <Button
                            Margin="0,0,0,16"
                            BackgroundColor="{AppThemeBinding Light={StaticResource LightSecondaryContainer},
                                                              Dark={StaticResource DarkSecondaryContainer}}"
                            Command="{Binding ShowAllPasswordsCommand}"
                            CornerRadius="{StaticResource Large}"
                            FontFamily="{StaticResource MaterialMediumFont}"
                            FontSize="{StaticResource tMedium}"
                            Text="All Passwords"
                            TextColor="{AppThemeBinding Light={StaticResource LightOnSecondaryContainer},
                                                        Dark={StaticResource DarkOnSecondaryContainer}}" />

                        <CollectionView
                            x:Name="CategoriesCollection"
                            ItemsSource="{Binding Categories}"
                            SelectedItem="{Binding SelectedCategory}"
                            SelectionMode="Single">
                            <CollectionView.ItemsLayout>
                                <LinearItemsLayout ItemSpacing="{x:StaticResource sContent}" Orientation="Vertical" />
                            </CollectionView.ItemsLayout>
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <controls:CategoryItemCell
                                        ActionIconGlyph="{x:Static m:MaterialRounded.More_vert}"
                                        IconGlyph="{x:Static m:MaterialRounded.Folder}"
                                        Text="{Binding Name}">
                                        <!--  Context Menu  -->
                                        <FlyoutBase.ContextFlyout>
                                            <MenuFlyout>
                                                <MenuFlyoutItem
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainPageViewModel}}, Path=EditCategoryCommand}"
                                                    CommandParameter="{Binding .}"
                                                    Text="Edit">
                                                    <MenuFlyoutItem.IconImageSource>
                                                        <FontImageSource
                                                            FontFamily="MaterialRounded"
                                                            Glyph="{x:Static m:MaterialRounded.Edit}"
                                                            Color="{StaticResource Primary}" />
                                                    </MenuFlyoutItem.IconImageSource>
                                                </MenuFlyoutItem>

                                                <MenuFlyoutItem
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainPageViewModel}}, Path=DeleteCategoryCommand}"
                                                    CommandParameter="{Binding .}"
                                                    Text="Delete">
                                                    <MenuFlyoutItem.IconImageSource>
                                                        <FontImageSource
                                                            FontFamily="MaterialRounded"
                                                            Glyph="{x:Static m:MaterialRounded.Delete}"
                                                            Color="{StaticResource Error}" />
                                                    </MenuFlyoutItem.IconImageSource>
                                                </MenuFlyoutItem>
                                            </MenuFlyout>
                                        </FlyoutBase.ContextFlyout>
                                    </controls:CategoryItemCell>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </controls:Component>
                <!--  Pas   sword Entries List  -->
                <controls:Component Grid.Row="1" Grid.Column="1">
                    <VerticalStackLayout>
                        <controls:ComponentHeader Title="Passwords">
                            <controls:ComponentHeader.Actions>
                                <HorizontalStackLayout Spacing="{x:StaticResource sContent}" VerticalOptions="Center">
                                    <controls:ImageButton Command="{Binding SortEntriesCommand}" IconGlyph="{x:Static m:MaterialRounded.Sort}" />
                                    <controls:ImageButton Command="{Binding CreateEntryCommand}" IconGlyph="{x:Static m:MaterialRounded.Add}" />
                                </HorizontalStackLayout>
                            </controls:ComponentHeader.Actions>
                        </controls:ComponentHeader>
                        <CollectionView
                            x:Name="EntriesCollection"
                            ItemsSource="{Binding Passwords}"
                            SelectedItem="{Binding SelectedEntry}"
                            SelectionMode="Single">
                            <CollectionView.ItemsLayout>
                                <LinearItemsLayout ItemSpacing="{x:StaticResource sContent}" Orientation="Vertical" />
                            </CollectionView.ItemsLayout>
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <controls:CategoryItemCell
                                        ActionIconGlyph="{x:Static m:MaterialRounded.More_vert}"
                                        IconGlyph="{x:Static m:MaterialRounded.Key}"
                                        Text="{Binding Site}">
                                        <!--  Context Menu  -->
                                        <FlyoutBase.ContextFlyout>
                                            <MenuFlyout>
                                                <MenuFlyoutItem
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainPageViewModel}}, Path=EditEntryCommand}"
                                                    CommandParameter="{Binding .}"
                                                    Text="Edit">
                                                    <MenuFlyoutItem.IconImageSource>
                                                        <FontImageSource
                                                            FontFamily="MaterialRounded"
                                                            Glyph="{x:Static m:MaterialRounded.Edit}"
                                                            Color="{StaticResource Primary}" />
                                                    </MenuFlyoutItem.IconImageSource>
                                                </MenuFlyoutItem>
                                                <MenuFlyoutItem
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainPageViewModel}}, Path=DeleteEntryCommand}"
                                                    CommandParameter="{Binding .}"
                                                    Text="Delete">
                                                    <MenuFlyoutItem.IconImageSource>
                                                        <FontImageSource
                                                            FontFamily="MaterialRounded"
                                                            Glyph="{x:Static m:MaterialRounded.Delete}"
                                                            Color="{StaticResource Error}" />
                                                    </MenuFlyoutItem.IconImageSource>
                                                </MenuFlyoutItem>
                                            </MenuFlyout>
                                        </FlyoutBase.ContextFlyout>
                                    </controls:CategoryItemCell>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </controls:Component>
                <!--  Password Entry Details View  -->
                <controls:Component
                    Grid.Row="1"
                    Grid.Column="2"
                    BorderMargin="0"
                    IsVisible="{Binding SelectedEntry, Converter={StaticResource IsNotNullConverter}}">
                    <controls:EntryDetailView Grid.Column="2" BindingContext="{Binding SelectedEntry}">
                        <controls:EntryDetailView.Triggers>
                            <DataTrigger
                                Binding="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SelectedEntry}"
                                TargetType="controls:EntryDetailView"
                                Value="{x:Null}">
                                <Setter Property="IsVisible" Value="False" />
                            </DataTrigger>
                        </controls:EntryDetailView.Triggers>
                    </controls:EntryDetailView>
                </controls:Component>
            </Grid>
        </VerticalStackLayout>
        <AbsoluteLayout
            x:Name="GoatContainer"
            Margin="20"
            InputTransparent="True">
            <!--  Goat Lottie animation  -->
            <skia:SKLottieView
                x:Name="GoatMascot"
                AbsoluteLayout.LayoutBounds="1,1,120,120"
                AbsoluteLayout.LayoutFlags="PositionProportional"
                HeightRequest="120"
                HorizontalOptions="End"
                RepeatCount="-1"
                Source="goat.json"
                VerticalOptions="End"
                WidthRequest="120" />
            <!--  Speech bubble above the goat  -->
            <StackLayout
                x:Name="GoatBubbleStack"
                AbsoluteLayout.LayoutBounds="1,0.8,AutoSize,AutoSize"
                AbsoluteLayout.LayoutFlags="PositionProportional"
                Opacity="0"
                Orientation="Vertical"
                Spacing="0">
                <Border
                    Padding="12"
                    BackgroundColor="White"
                    HorizontalOptions="End"
                    StrokeShape="RoundRectangle 12">
                    <Label
                        FontAttributes="Bold"
                        LineBreakMode="WordWrap"
                        MaxLines="3"
                        Text="{Binding GoatComment}"
                        TextColor="Black" />
                </Border>
                <!--  Small triangle pointing to the goat  -->
                <BoxView
                    Margin="0,-8,16,0"
                    BackgroundColor="White"
                    HeightRequest="12"
                    HorizontalOptions="End"
                    Rotation="45"
                    WidthRequest="12" />
            </StackLayout>
        </AbsoluteLayout>
    </Grid>
</ContentPage>
name: .NET 10 MAUI Deployment

on:
  push:
    branches:
      - main
      - refactor-v4
    paths-ignore:
      - "*.md"
  pull_request:
    branches:
      - main
      - refactor-v4
    paths-ignore:
      - "*.md"

permissions:
  contents: write

env:
  WORKING_DIRECTORY: "./GoatVaultClient-v4"

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup .NET 10 SDK
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: "10.0.x"

      # --------------------------
      # Cache NuGet packages & MAUI workloads
      # --------------------------

      - name: Cache NuGet packages
        uses: actions/cache@v3
        with:
          path: ${{ env.USERPROFILE }}\.nuget\packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Cache .NET workloads
        uses: actions/cache@v3
        with:
          path: ${{ env.USERPROFILE }}\.dotnet\workloads
          key: ${{ runner.os }}-dotnet-workloads-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-dotnet-workloads-

      # --------------------------
      # Install MAUI workload if missing
      # --------------------------

      - name: Install MAUI workload
        run: |
          if (-not (dotnet workload list | Select-String "maui")) {
            dotnet workload install maui
          }

      # --------------------------
      # Restore & build solution
      # --------------------------

      - name: Restore dependencies
        run: dotnet restore GoatVaultClient-v4.slnx
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Build the project
        run: dotnet build GoatVaultClient-v4.slnx -c Release
        working-directory: ${{ env.WORKING_DIRECTORY }}

      # --------------------------
      # Decode & install signing certificate
      # --------------------------

      - name: Decode signing certificate
        run: |
          echo "${{ secrets.SIGNING_CERTIFICATE_BASE64_CONTENT }}" > cert.asc
          certutil -decode cert.asc cert.pfx

      - name: Install signing certificate
        run: certutil -user -p ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }} -Silent -importpfx cert.pfx NoRoot

      # --------------------------
      # Publish client
      # --------------------------

      - name: Publish the client
        run: dotnet publish GoatVaultClient/GoatVaultClient.csproj -c Release -f:net10.0-windows10.0.19041.0 /p:GenerateAppxPackage=true /p:AppxPackageSigningEnabled=true /p:PackageCertificateThumbprint=${{ secrets.WINDOWS_CERTIFICATE_THUMBPRINT }}
        working-directory: ${{ env.WORKING_DIRECTORY }}

      # --------------------------
      # Extract version
      # --------------------------

      - name: Extract version
        id: extract_version
        shell: pwsh
        run: |
          $xml = [xml](Get-Content "${{ env.WORKING_DIRECTORY }}/GoatVaultClient/GoatVaultClient.csproj")

          $display = $xml.Project.PropertyGroup | Where-Object { $_.ApplicationDisplayVersion } | Select-Object -First 1
          $full = $display.ApplicationDisplayVersion
          "version=$full" >> $env:GITHUB_OUTPUT

      # --------------------------
      # Create Git tag
      # --------------------------

      - name: Create Tag
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/tags/v${{ steps.extract_version.outputs.version }}`,
              sha: context.sha
            });

      # --------------------------
      # Rename published files
      # --------------------------

      - name: Rename Auto-Update Installer
        shell: pwsh
        run: |
          Rename-Item ${{ env.WORKING_DIRECTORY }}/bin/Release/net10.0-windows10.0.19041.0/win-x64/AppPackages/GoatVaultClient_${{ steps.extract_version.outputs.version }}_Test/GoatVaultClient_${{ steps.extract_version.outputs.version }}_x64.msix AutoUpdate.msix

      - name: Rename Certificate
        shell: pwsh
        run: |
          Rename-Item ${{ env.WORKING_DIRECTORY }}/bin/Release/net10.0-windows10.0.19041.0/win-x64/AppPackages/GoatVaultClient_${{ steps.extract_version.outputs.version }}_Test/GoatVaultClient_${{ steps.extract_version.outputs.version }}_x64.cer GoatVaultClient.cer

      # --------------------------
      # Create GitHub release
      # --------------------------

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.extract_version.outputs.version }}
          files: |
            ${{ env.WORKING_DIRECTORY }}/GoatVaultClient.appinstaller
            ${{ env.WORKING_DIRECTORY }}/bin/Release/net10.0-windows10.0.19041.0/win-x64/AppPackages/GoatVaultClient_${{ steps.extract_version.outputs.version }}_Test/AutoUpdate.msix
            ${{ env.WORKING_DIRECTORY }}/bin/Release/net10.0-windows10.0.19041.0/win-x64/AppPackages/GoatVaultClient_${{ steps.extract_version.outputs.version }}_Test/GoatVaultClient.cer

name: .NET 10 MAUI Deployment - Android

on:
  push:
    branches:
      - android-deployment
    paths-ignore:
      - "*.md"
  pull_request:
    branches:
      - android-deployment
    paths-ignore:
      - "*.md"
      
permissions:
  contents: write

env:
  WORKING_DIRECTORY: "./GoatVaultClient-v4"
  DOTNET_VERSION: "10.0.x"
  TARGET_FRAMEWORK: "net10.0-android"
  CONFIGURATION: "Release"

jobs:
   android-build:
    runs-on: ubuntu-latest

    steps:
    # --------------------------
    # Checkout repository
    # --------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # --------------------------
    # Setup .NET SDK
    # --------------------------
    - name: Setup .NET 10 SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        dotnet-quality: "preview"

   # --------------------------
   # Enable caching for .NET packages and MAUI workloads
   # --------------------------

    - name: Cache .NET packages
      uses: actions/cache@v4
      with:
          path: ${{ github.workspace }}\..\..\.nuget\packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

    - name: Cache MAUI workloads
      uses: actions/cache@v4
      with:
          path: |
            ~\AppData\Local\Microsoft\dotnet\workloads
            C:\Program Files\dotnet\sdk-manifests
            C:\Program Files\dotnet\metadata
          key: ${{ runner.os }}-maui-workloads-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-maui-workloads-

    # --------------------------
    # Restore dependencies + workloads
    # --------------------------

    - name: Restore workloads
      run: dotnet workload restore GoatVaultClient/GoatVaultClient.csproj
      working-directory: ${{ env.WORKING_DIRECTORY }}
      
    # --------------------------
    # Restore only Android workloads & NuGet packages
    # --------------------------
    - name: Restore Android dependencies
      run: dotnet restore GoatVaultClient/GoatVaultClient.csproj -f ${{ env.TARGET_FRAMEWORK }}
      working-directory: ${{ env.WORKING_DIRECTORY }}

    # --------------------------
    # Decode keystore file from secrets
    # --------------------------
    - name: Decode Android keystore
      run: |
        echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > index.keystore

    # --------------------------
    # Build & sign Android app
    # --------------------------
    - name: Build Android MAUI app
      run: |
        dotnet publish GoatVaultClient/GoatVaultClient.csproj \
          -f ${{ env.TARGET_FRAMEWORK }} \
          -c ${{ env.CONFIGURATION }} \
          -o ${{ github.workspace }}/android-build \
          -p:AndroidKeyStore=true \
          -p:AndroidSigningKeyStore=index.keystore \
          -p:AndroidSigningKeyAlias=${{ secrets.ANDROID_KEY_ALIAS }} \
          -p:AndroidSigningKeyPass=${{ secrets.ANDROID_KEY_PASSWORD }} \
          -p:AndroidSigningStorePass=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      working-directory: ${{ env.WORKING_DIRECTORY }}

    # --------------------------
    # Upload APK/AAB artifact
    # --------------------------
    - name: Upload Android build artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-app
        path: android-build/**
        retention-days: 30

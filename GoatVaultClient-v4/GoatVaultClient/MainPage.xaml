<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:uranium="http://schemas.enisn-projects.io/dotnet/maui/uraniumui"
             xmlns:material="http://schemas.enisn-projects.io/dotnet/maui/uraniumui/material"
             xmlns:vm="clr-namespace:GoatVaultClient.ViewModels"
             xmlns:models="clr-namespace:GoatVaultCore.Models;assembly=GoatVaultCore"
             xmlns:controls="clr-namespace:GoatVaultClient.Controls"
             xmlns:m="clr-namespace:UraniumUI.Icons.MaterialSymbols;assembly=UraniumUI.Icons.MaterialSymbols"
             x:Class="GoatVaultClient.MainPage"
             BackgroundColor="{AppThemeBinding Light={x:StaticResource LightSurface}, Dark={x:StaticResource DarkSurface}}">


    <VerticalStackLayout>
        <!-- Sync Status Bar -->
        <controls:Component BorderMargin="24,8,24,0">
            <Grid ColumnDefinitions="Auto,*,Auto" 
                  Padding="12,8"
                  BackgroundColor="{AppThemeBinding Light={x:StaticResource LightSurfaceContainer}, Dark={x:StaticResource DarkSurfaceContainer}}"
                  RowSpacing="0">

                <!-- Sync Icon -->
                <Image Grid.Column="0" 
                       Source="{Binding SyncButtonIcon}"
                       WidthRequest="20"
                       HeightRequest="20"
                       VerticalOptions="Center"
                       Margin="0,0,8,0">
                    <Image.Triggers>
                        <DataTrigger TargetType="Image" Binding="{Binding IsSyncing}" Value="True">
                            <DataTrigger.EnterActions>
                                <!--<Trigger>
                                    --><!-- Add rotation animation here if desired --><!--
                                </Trigger>-->
                            </DataTrigger.EnterActions>
                        </DataTrigger>
                    </Image.Triggers>
                </Image>

                <!-- Status Text -->
                <VerticalStackLayout Grid.Column="1" Spacing="2" VerticalOptions="Center">
                    <Label Text="{Binding SyncStatusText}"
                           FontSize="14"
                           FontAttributes="Bold"
                           TextColor="{AppThemeBinding Light={x:StaticResource LightOnSurface}, Dark={x:StaticResource DarkOnSurface}}"/>
                    <Label Text="{Binding LastSyncTime, StringFormat='Last sync: {0}'}"
                           FontSize="12"
                           TextColor="{AppThemeBinding Light={x:StaticResource LightOnSurfaceVariant}, Dark={x:StaticResource DarkOnSurfaceVariant}}"
                           IsVisible="{Binding LastSyncTime, Converter={StaticResource StringNotEmptyConverter}}"/>
                </VerticalStackLayout>

                <!-- Sync Button -->
                <Button Grid.Column="2"
                        Text="Sync Now"
                        Command="{Binding SyncVaultCommand}"
                        IsEnabled="{Binding IsSyncing, Converter={StaticResource InvertedBoolConverter}}"
                        BackgroundColor="{AppThemeBinding Light={x:StaticResource LightPrimary}, Dark={x:StaticResource DarkPrimary}}"
                        TextColor="{AppThemeBinding Light={x:StaticResource LightOnPrimary}, Dark={x:StaticResource DarkOnPrimary}}"
                        CornerRadius="8"
                        Padding="16,8"
                        FontSize="14"
                        FontAttributes="Bold">
                    <Button.Triggers>
                        <DataTrigger TargetType="Button" Binding="{Binding HasUnsavedChanges}" Value="True">
                            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={x:StaticResource LightSecondary}, Dark={x:StaticResource DarkSecondary}}" />
                        </DataTrigger>
                    </Button.Triggers>
                </Button>
            </Grid>
        </controls:Component>
        <controls:Component BorderMargin="24,0,24,0">
            <SearchBar Placeholder="Search passwords..." Text="{Binding SearchText}" HeightRequest="48" />
        </controls:Component>
        <Grid RowDefinitions="Auto,*" ColumnDefinitions="Auto, 0.5*, 0.5*" Margin="{StaticResource layoutMargin}" BackgroundColor="{AppThemeBinding Light={x:StaticResource LightSurface}, Dark={x:StaticResource DarkSurface}}">

            <controls:Component Grid.Row="1" Grid.Column="0" >
                <VerticalStackLayout>
                    <controls:ComponentHeader Title="Categories">
                        <controls:ComponentHeader.Actions>
                            <HorizontalStackLayout Spacing="{x:StaticResource sContent}">
                                <controls:ImageButton IconGlyph="{x:Static m:MaterialRounded.Sort}"
                                              Command="{Binding SortCategoriesCommand}"/>
                                <controls:ImageButton IconGlyph="{x:Static m:MaterialRounded.Add}"
                                              Command="{Binding CreateCategoryCommand}"/>
                            </HorizontalStackLayout>
                        </controls:ComponentHeader.Actions>
                    </controls:ComponentHeader >
                    <CollectionView x:Name="CategoriesCollection" ItemsSource="{Binding Categories}" SelectionMode="Single" SelectedItem="{Binding SelectedCategory}">
                        <CollectionView.ItemsLayout>
                            <LinearItemsLayout Orientation="Vertical" ItemSpacing="{x:StaticResource sContent}" />
                        </CollectionView.ItemsLayout>
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <controls:CategoryItemCell Text="{Binding Name}"
                                                   IconGlyph="{x:Static m:MaterialRounded.Folder}"         
                                                   ActionIconGlyph="{x:Static m:MaterialRounded.More_vert}">
                                    <!-- Context Menu-->
                                    <FlyoutBase.ContextFlyout>
                                        <MenuFlyout>
                                            <MenuFlyoutItem Text="Edit"
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainPageViewModel}}, Path=EditCategoryCommand}"
                                                            CommandParameter="{Binding .}">
                                                <MenuFlyoutItem.IconImageSource>
                                                    <FontImageSource FontFamily="MaterialRounded" Glyph="{x:Static m:MaterialRounded.Edit}" Color="{StaticResource Primary}"/>
                                                </MenuFlyoutItem.IconImageSource>
                                            </MenuFlyoutItem>

                                            <MenuFlyoutItem Text="Delete"
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainPageViewModel}}, Path=DeleteCategoryCommand}"
                                                            CommandParameter="{Binding .}">
                                                <MenuFlyoutItem.IconImageSource>
                                                    <FontImageSource FontFamily="MaterialRounded" Glyph="{x:Static m:MaterialRounded.Delete}" Color="{StaticResource Error}"/>
                                                </MenuFlyoutItem.IconImageSource>
                                            </MenuFlyoutItem>
                                        </MenuFlyout>
                                    </FlyoutBase.ContextFlyout>
                                </controls:CategoryItemCell>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </controls:Component>
            <controls:Component Grid.Row="1" Grid.Column="1">
                <VerticalStackLayout>
                    <controls:ComponentHeader Title="Passwords">
                        <controls:ComponentHeader.Actions>
                            <HorizontalStackLayout Spacing="{x:StaticResource sContent}"
                                           VerticalOptions="Center">
                                <controls:ImageButton IconGlyph="{x:Static m:MaterialRounded.Sort}"
                                              Command="{Binding SortEntriesCommand}"/>
                                <controls:ImageButton IconGlyph="{x:Static m:MaterialRounded.Add}"
                                              Command="{Binding CreateEntryCommand}"/>
                            </HorizontalStackLayout>
                        </controls:ComponentHeader.Actions>
                    </controls:ComponentHeader>
                    <CollectionView x:Name="EntriesCollection" ItemsSource="{Binding Passwords}" SelectionMode="Single" SelectedItem="{Binding SelectedEntry}">
                        <CollectionView.ItemsLayout>
                            <LinearItemsLayout Orientation="Vertical" ItemSpacing="{x:StaticResource sContent}" />
                        </CollectionView.ItemsLayout>
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <controls:CategoryItemCell Text="{Binding Site}"
                                   IconGlyph="{x:Static m:MaterialRounded.Key}"         
                                   ActionIconGlyph="{x:Static m:MaterialRounded.More_vert}">
                                    <!-- Context Menu-->
                                    <FlyoutBase.ContextFlyout>
                                        <MenuFlyout>
                                            <MenuFlyoutItem Text="Edit"
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainPageViewModel}}, Path=EditEntryCommand}"
                                                            CommandParameter="{Binding .}">
                                                <MenuFlyoutItem.IconImageSource>
                                                    <FontImageSource FontFamily="MaterialRounded" Glyph="{x:Static m:MaterialRounded.Edit}" Color="{StaticResource Primary}"/>
                                                </MenuFlyoutItem.IconImageSource>
                                            </MenuFlyoutItem>
                                            <MenuFlyoutItem Text="Delete"
                                                                  Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainPageViewModel}}, Path=DeleteEntryCommand}"
                                                                  CommandParameter="{Binding .}">
                                                <MenuFlyoutItem.IconImageSource>
                                                    <FontImageSource FontFamily="MaterialRounded" Glyph="{x:Static m:MaterialRounded.Delete}" Color="{StaticResource Error}"/>
                                                </MenuFlyoutItem.IconImageSource>
                                            </MenuFlyoutItem>
                                        </MenuFlyout>
                                    </FlyoutBase.ContextFlyout>
                                </controls:CategoryItemCell>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </controls:Component>
            <controls:Component Grid.Row="1" Grid.Column="2" BorderMargin="0">
                <controls:EntryDetailView Grid.Column="2" 
                      BindingContext="{Binding SelectedEntry}">
                    <controls:EntryDetailView.Triggers>
                        <DataTrigger TargetType="controls:EntryDetailView" 
                             Binding="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SelectedEntry}"
                             Value="{x:Null}">
                            <Setter Property="IsVisible" Value="False" />
                        </DataTrigger>
                    </controls:EntryDetailView.Triggers>
                </controls:EntryDetailView>
            </controls:Component>
        </Grid>
    </VerticalStackLayout>
</ContentPage>